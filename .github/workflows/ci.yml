name: CI Docker Compose

on: [push]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Set up Python (for pytest)
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # Step 3: Install Python dependencies for tests
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt pytest requests

      # Step 4: Build Docker images (from docker-compose.yml)
      - name: Build Docker images
        run: docker compose build

      # ------------------------------------------------
      # OPTIONAL: Run training pipeline
      # ------------------------------------------------
      - name: Run training service
        run: docker compose --profile train up --abort-on-container-exit train

      # Step 5: Start API and MLflow services
      - name: Start API and MLflow services
        run: docker compose up -d api mlflow

      # Step 6: Wait for services to be ready
      - name: Wait for services
        run: sleep 30

      # Step 7: Test API from container
      - name: Test API endpoint
        run: docker compose exec api python /app/test_request.py

      # Step 8: Run unit tests
      - name: Run pytest
        run: |
          PYTHONPATH=$PWD pytest tests/ --maxfail=1 --disable-warnings -v

      # Step 9: Cleanup
      - name: Cleanup containers
        if: always()
        run: docker compose down -v
